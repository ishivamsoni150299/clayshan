<section class="container collections" (touchstart)="onTouchStart($event)" (touchmove)="onTouchMove($event)" (touchend)="onTouchEnd()">
  <div class="ptr" [style.height.px]="pullY()" [class.refreshing]="refreshing()">
    <div class="inner">
      <div class="spinner" *ngIf="refreshing(); else arrow"></div>
      <ng-template #arrow><div class="arrow" [style.transform]="'rotate(' + angle() + 'deg)'">↻</div></ng-template>
      <div class="msg">{{ refreshing() ? 'Refreshing…' : (pullY()>60 ? 'Release to refresh' : 'Pull to refresh') }}</div>
    </div>
  </div>
  <h1>Collections</h1>
  <div class="toolbar sticky">
    <div class="row desktop">
      <input [value]="query()" (input)="setQuery($any($event.target).value)" type="search" placeholder="Search jewellery..." />
      <select [ngModel]="category()" (ngModelChange)="setCategory($event)">
        <option [ngValue]="null">All categories</option>
        <option *ngFor="let c of categories()" [ngValue]="c">{{ c }}</option>
      </select>
      <select [ngModel]="sort()" (ngModelChange)="setSort($event)">
        <option [ngValue]="'reco'">Recommended</option>
        <option [ngValue]="'price_asc'">Price: Low to High</option>
        <option [ngValue]="'price_desc'">Price: High to Low</option>
        <option [ngValue]="'name_asc'">Name: A–Z</option>
      </select>
      <button class="link" *ngIf="query() || category()" (click)="clearFilters()">Clear</button>
    </div>
    <div class="mobile-bar">
      <button class="btn" (click)="openFilters()">Filters & Sort</button>
      <div class="summary" *ngIf="category() || min() != null || max() != null || query()">Filtered</div>
    </div>
    <div class="chips">
      <button class="chip" [class.active]="!category() && !featured()" (click)="setCategory(null); setFeatured(false)">All</button>
      <button class="chip" [class.active]="featured()" (click)="setFeatured(!featured())">Featured</button>
      <button class="chip" *ngFor="let c of categories()" [class.active]="category()===c" (click)="setCategory(c)">{{ c }}</button>
    </div>
    <div class="active-chips" *ngIf="hasActive()">
      <button class="chip active" *ngIf="query()">“{{ query() }}” <span class="x" (click)="clearQuery()">×</span></button>
      <button class="chip active" *ngIf="category()">{{ category() }} <span class="x" (click)="clearCategory()">×</span></button>
      <button class="chip active" *ngIf="min()!=null">Min ₹{{ min() }} <span class="x" (click)="clearMin()">×</span></button>
      <button class="chip active" *ngIf="max()!=null">Max ₹{{ max() }} <span class="x" (click)="clearMax()">×</span></button>
      <button class="chip active" *ngIf="featured()">Featured <span class="x" (click)="clearFeatured()">×</span></button>
      <button class="chip clear-all" (click)="clearFilters()">Reset</button>
    </div>
  </div>
  <div class="grid">
    <ng-container *ngIf="productService.status() === 'loading'">
      <app-skeleton-card *ngFor="let i of [1,2,3,4,5,6,7,8,9,10,11,12]"></app-skeleton-card>
    </ng-container>
    <ng-container *ngIf="productService.status() !== 'loading'">
      <app-product-card *ngFor="let p of items()" [product]="p" [featured]="isPinned(p.slug)" />
      <div #sentinel class="sentinel" aria-hidden="true"></div>
    </ng-container>
    <div class="empty-state" *ngIf="productService.status() !== 'loading' && items().length === 0">
      <div class="msg">
        <strong>No live products to show right now.</strong>
        <div>Try clearing filters or checking again in a moment.</div>
      </div>
    </div>
  </div>
</section>

<!-- Filters Drawer (mobile) -->
<div class="drawer" *ngIf="filtersOpen()" (click)="closeFilters()">
  <div class="sheet filter-sheet" (click)="$event.stopPropagation()">
    <header class="head">
      <div class="title">Filters & Sort</div>
      <button class="close" (click)="closeFilters()" aria-label="Close">×</button>
    </header>
    <div class="fields">
      <label>Search</label>
      <input [value]="query()" (input)="setQuery($any($event.target).value)" type="search" placeholder="Search jewellery..." />

      <label>Category</label>
      <select [ngModel]="category()" (ngModelChange)="setCategory($event)">
        <option [ngValue]="null">All categories</option>
        <option *ngFor="let c of categories()" [ngValue]="c">{{ c }}</option>
      </select>

      <label>Price range (₹{{ extentMin() }} – ₹{{ extentMax() }})</label>
      <div class="range">
        <input type="range" [min]="extentMin()" [max]="extentMax()" [ngModel]="min() ?? extentMin()" (ngModelChange)="setMin($event)" />
        <input type="range" [min]="extentMin()" [max]="extentMax()" [ngModel]="max() ?? extentMax()" (ngModelChange)="setMax($event)" />
      </div>
      <div class="range-values">
        <input type="number" [value]="min() ?? ''" (input)="setMin($any($event.target).value ? +$any($event.target).value : null)" placeholder="Min" />
        <input type="number" [value]="max() ?? ''" (input)="setMax($any($event.target).value ? +$any($event.target).value : null)" placeholder="Max" />
      </div>

      <label>Sort</label>
      <select [ngModel]="sort()" (ngModelChange)="setSort($event)">
        <option [ngValue]="'reco'">Recommended</option>
        <option [ngValue]="'price_asc'">Price: Low to High</option>
        <option [ngValue]="'price_desc'">Price: High to Low</option>
        <option [ngValue]="'name_asc'">Name: A–Z</option>
      </select>

      <label>Special</label>
      <div>
        <label><input type="checkbox" [checked]="featured()" (change)="setFeatured($any($event.target).checked)" /> Featured only</label>
      </div>
    </div>
    <div class="sticky-actions">
      <button class="btn" (click)="clearFilters()">Clear</button>
      <button class="btn primary" (click)="closeFilters()">Apply</button>
    </div>
  </div>
  </div>
