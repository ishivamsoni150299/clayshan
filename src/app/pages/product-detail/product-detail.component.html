<nav class="breadcrumbs container">
  <a routerLink="/">Home</a> / <a routerLink="/collections">Collections</a> /
  <span>{{ product?.name || 'Loading…' }}</span>
</nav>

<section class="container" *ngIf="product as p; else pending">
  <div class="layout amazon">
    <!-- Gallery -->
    <div class="gallery">
      <div class="thumbs">
        <button *ngFor="let img of p.images; let i = index" (click)="select(img)" [class.active]="(selectedImage || p.images[0]) === img" aria-label="Image {{i+1}}">
          <img [src]="img" [alt]="p.name + ' ' + (i+1)" (error)="onImgError($event)" width="92" height="92" loading="lazy" decoding="async" />
        </button>
      </div>
      <div class="main" (touchstart)="onTouchStart($event)" (touchmove)="onTouchMove($event)" (touchend)="onTouchEnd()" (click)="openFs()">
        <button class="nav prev" *ngIf="p.images && p.images.length > 1" (click)="prevImage()" aria-label="Previous image">&lsaquo;</button>
        <button class="nav next" *ngIf="p.images && p.images.length > 1" (click)="nextImage()" aria-label="Next image">&rsaquo;</button>
        <img [src]="selectedImage || p.images[0]" [alt]="p.name" (error)="onImgError($event)" width="1000" height="1000" decoding="async"
             sizes="(max-width: 900px) 100vw, 50vw"
             (mouseenter)="zoomIn($event)" (mousemove)="zoomMove($event)" (mouseleave)="zoomOut()"
             [style.transform]="zoom ? 'scale(1.6)' : 'scale(1)'" [style.transform-origin]="origin" [class.zoom]="zoom" />
      </div>
    </div>

    <!-- Info (middle column) -->
    <div class="info col-mid">
      <h1>{{ p.name }}</h1>
      <div class="rating"><span class="stars">?????</span> <span class="count">({{ (p.slug.length || 10) * 7 % 180 + 20 }})</span></div>

      <div class="price-block">
        <div class="row">
          <span class="discount" *ngIf="discountPercent()>0">-{{ discountPercent() }}%</span>
          <span class="price">{{ displayPrice() | currency: p.currency }}</span>
        </div>
        <div class="mrp" *ngIf="mrp()>0">M.R.P.: <s>{{ mrp() | currency: p.currency }}</s></div>
        <div class="inc">Inclusive of all taxes</div>
      </div>

      <div class="offers">
        <div class="tile">Cashback Offer<br/><small>Save up to ?1,131</small></div>
        <div class="tile">Bank Offer<br/><small>Save up to ?1,000</small></div>
        <div class="tile">Partner Offer<br/><small>Save up to 18%</small></div>
      </div>

      <div class="selected" *ngIf="variantAttrs.length">
        <span class="lab">Selected:</span>
        <span class="vals"><ng-container *ngFor="let kv of (selectedAttrs | keyvalue); let last = last">{{kv.key}}: {{kv.value}}{{ last ? '' : ', '}}</ng-container></span>
      </div>

      <div class="micro" *ngIf="stockText">{{ stockText }}</div>
      <div class="micro good" *ngIf="cutoffText">{{ cutoffText }}</div>

      <p class="desc">{{ p.description }}</p>

      <ul class="highlights" *ngIf="highlights.length"><li *ngFor="let h of highlights">{{ h }}</li></ul>

      <div class="variants" *ngIf="variantAttrs.length">
        <div class="group" *ngFor="let attr of variantAttrs">
          <div class="label">{{ attr }}</div>
          <div class="chips">
            <button class="chip" *ngFor="let val of (attrValues[attr] || [])" [class.active]="selectedAttrs[attr]===val" (click)="setAttr(attr, val)">{{ val }}</button>
          </div>
        </div>
      </div>

      <div class="policy">
        <span>?? Free Shipping</span>
        <span>?? 7-day Return</span>
        <span>??? Quality Assured</span>
      </div>

      <div class="pincode">
        <input placeholder="Check delivery pincode" [(ngModel)]="pin" name="pin" maxlength="6" />
        <button class="btn" (click)="checkPin()">Check</button>
        <span class="eta" *ngIf="eta">Estimated delivery by {{ eta }}</span>
      </div>

      <div class="actions">
        <div class="qty">
          <button class="q" (click)="dec()" aria-label="Decrease quantity">-</button>
          <input [value]="qty" readonly aria-label="Quantity" />
          <button class="q" (click)="inc()" aria-label="Increase quantity">+</button>
        </div>
        <button class="btn primary" (click)="addToCart()">Add to Cart</button>
        <button class="btn wish" type="button" (click)="wishlist.toggle(p.id || p.slug)">{{ wishlist.has(p.id || p.slug) ? '? Wishlisted' : '? Wishlist' }}</button>
        <a class="btn" routerLink="/cart" *ngIf="added">View Cart</a>
        <a class="btn" routerLink="/contact">Enquire</a>
        <a class="btn" target="_blank" rel="noopener" [href]="whatsappProductLink(p)">WhatsApp</a>
        <button class="btn" type="button" (click)="copyLink()">Copy Link</button>
      </div>

      <div class="related" *ngIf="related?.length">
        <h3>Similar pieces</h3>
        <div class="grid"><app-product-card *ngFor="let r of related" [product]="r"></app-product-card></div>
      </div>
    </div>

    <aside class="buy-box">
      <div class="price">{{ displayPrice() | currency: p.currency }}</div>
      <div class="ship">FREE delivery available</div>
      <div class="pin">Deliver to you – India</div>
      <div class="stock" [class.low]="selectedVariantQty()<=2">{{ stockNotice() }}</div>
      <div class="qty-select">
        <label for="qtySel">Qty</label>
        <select id="qtySel" [(ngModel)]="qty" name="qtySel">
          <option *ngFor="let n of [1,2,3,4,5,6,7,8,9,10]" [value]="n">{{ n }}</option>
        </select>
      </div>
      <button class="btn big primary" (click)="addToCart()">Add to Cart</button>
      <button class="btn big buy" (click)="buyNow()">Buy Now</button>
    </aside>
  </div>

</section>

<section class="container reviews" *ngIf="product as p">
  <div class="head">
    <h2>Customer Reviews</h2>
    <div class="summary"><span class="stars">?????</span> <b>{{ avgStars }}</b>/5 • {{ reviews.length }} review{{ reviews.length===1? '' : 's' }}</div>
    <button class="btn" type="button" (click)="shareNative()">Share</button>
  </div>
  <div class="review-list">
    <div class="item" *ngFor="let r of reviews; let i = index">
      <div class="meta">
        <span class="stars" [attr.aria-label]="r.stars + ' stars'">{{ '?????'.slice(0, r.stars) }}</span>
        <span class="name">{{ r.name }}</span>
        <span class="date">{{ r.created_at | date:'mediumDate' }}</span>
      </div>
      <p class="text">{{ r.text }}</p>
    </div>
    <div class="empty" *ngIf="reviews.length===0">Be the first to review this product.</div>
  </div>

  <form class="review-form" (submit)="addReview($event)">
    <label>Rating</label>
    <div class="stars-input">
      <button type="button" *ngFor="let s of [1,2,3,4,5]" (click)="selectStars(s)" [class.active]="newStars>=s" aria-label="{{s}} star">?</button>
    </div>
    <label>Your name (optional)</label>
    <input type="text" [value]="newName" (input)="newName=$any($event.target).value" placeholder="Name"/>
    <label>Your review</label>
    <textarea rows="3" [value]="newText" (input)="newText=$any($event.target).value" placeholder="What did you like?"></textarea>
    <button class="btn primary" type="submit" [disabled]="!newText.trim().length">Submit review</button>
  </form>
</section>

<div class="lightbox" *ngIf="fsOpen" (click)="closeFs()">
  <div class="inner" (click)="$event.stopPropagation()">
    <button class="close" (click)="closeFs()" aria-label="Close">&times;</button>
    <button class="nav prev" *ngIf="product && product.images && product.images.length > 1" (click)="prevImage()" aria-label="Previous">&lsaquo;</button>
    <button class="nav next" *ngIf="product && product.images && product.images.length > 1" (click)="nextImage()" aria-label="Next">&rsaquo;</button>
    <div class="canvas" (touchstart)="fsTouchStart($event)" (touchmove)="fsTouchMove($event)" (touchend)="fsTouchEnd()" (dblclick)="toggleFsZoom()">
      <img [src]="selectedImage || product?.images?.[0]" [alt]="product?.name || ''" [style.transform]="'translate('+fsTx+'px,'+fsTy+'px) scale('+fsZoom+')'" />
    </div>
    <div class="thumbs">
      <button *ngFor="let img of product?.images || []" (click)="select(img)" [attr.aria-selected]="(selectedImage || product?.images?.[0])===img" [class.active]="(selectedImage || product?.images?.[0])===img">
        <img [src]="img" [alt]="product?.name || ''" />
      </button>
    </div>
  </div>
</div>

<div class="sticky-bar" *ngIf="product as p">
  <div class="inner">
    <div class="title">{{ p.name }}</div>
    <div class="price">{{ displayPrice() | currency: p.currency }}</div>
    <div class="qty">
      <button class="q" (click)="dec()" aria-label="Decrease quantity">-</button>
      <input [value]="qty" readonly aria-label="Quantity" />
      <button class="q" (click)="inc()" aria-label="Increase quantity">+</button>
    </div>
    <button class="btn primary" (click)="addToCart()">Add to Cart</button>
  </div>
</div>

<ng-template #pending>
  <section class="container"><p>Loading…</p></section>
</ng-template>