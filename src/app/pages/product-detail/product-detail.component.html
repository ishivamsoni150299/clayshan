<nav class="breadcrumbs container"><a routerLink="/">Home</a> / <a routerLink="/collections">Collections</a> / <span>{{ product?.name || 'Loadingâ€¦' }}</span></nav>
<section class="container" *ngIf="product as p; else pending">
  <script type="application/ld+json" *ngIf="jsonLdText" [textContent]="jsonLdText"></script>
  <script type="application/ld+json" *ngIf="breadcrumbJsonLd" [textContent]="breadcrumbJsonLd"></script>
  <div class="layout">
    <div class="gallery">
      <div class="thumbs">
        <button *ngFor="let img of p.images; let i = index" (click)="select(img)" [class.active]="(selectedImage || p.images[0]) === img" aria-label="Image {{i+1}}">
          <img [src]="img" [alt]="p.name + ' ' + (i+1)" (error)="onImgError($event)" width="92" height="92" loading="lazy" decoding="async" />
        </button>
      </div>
      <div class="main" (touchstart)="onTouchStart($event)" (touchmove)="onTouchMove($event)" (touchend)="onTouchEnd()" (click)="openFs()">
        <button class="nav prev" *ngIf="p.images && p.images.length > 1" (click)="prevImage()" aria-label="Previous image">â€¹</button>
        <button class="nav next" *ngIf="p.images && p.images.length > 1" (click)="nextImage()" aria-label="Next image">â€º</button>
        <picture>
          <source *ngIf="webpCandidate(selectedImage || p.images[0])" [attr.srcset]="webpCandidate(selectedImage || p.images[0])" type="image/webp" />
          <img [src]="selectedImage || p.images[0]" [alt]="p.name" (error)="onImgError($event)" width="1000" height="1000" decoding="async" sizes="(max-width: 900px) 100vw, 50vw"
               (mouseenter)="zoomIn($event)" (mousemove)="zoomMove($event)" (mouseleave)="zoomOut()"
               [style.transform]="zoom ? 'scale(1.6)' : 'scale(1)'"
               [style.transform-origin]="origin" [class.zoom]="zoom" />
        </picture>
      </div>
    </div>
    <div class="info">
      <h1>{{ p.name }}</h1>
      <div class="rating"><span class="stars">â˜…â˜…â˜…â˜…â˜…</span> <span class="count">({{ (p.slug.length || 10) * 7 % 180 + 20 }})</span></div>
      <div class="price">{{ p.price | currency: p.currency }}</div>
      <div class="micro" *ngIf="stockText">{{ stockText }}</div>
      <div class="micro good" *ngIf="cutoffText">{{ cutoffText }}</div>
      <p class="desc">{{ p.description }}</p>
      <ul class="highlights" *ngIf="highlights.length">
        <li *ngFor="let h of highlights">{{ h }}</li>
      </ul>
      <div class="variants">
        <div class="group">
          <div class="label">Color</div>
          <div class="chips">
            <button class="chip" [class.active]="tone==='gold'" (click)="setTone('gold')">Gold tone</button>
            <button class="chip" [class.active]="tone==='rose'" (click)="setTone('rose')">Rose gold</button>
            <button class="chip" [class.active]="tone==='silver'" (click)="setTone('silver')">Silver</button>
          </div>
        </div>
        <div class="group">
          <div class="label">Size</div>
          <div class="chips">
            <button class="chip" [class.active]="size==='S'" (click)="setSize('S')">S</button>
            <button class="chip" [class.active]="size==='M'" (click)="setSize('M')">M</button>
            <button class="chip" [class.active]="size==='L'" (click)="setSize('L')">L</button>
          </div>
        </div>
      </div>
      <div class="policy">
        <span>ğŸšš Free Shipping</span>
        <span>â†©ï¸ 7â€‘day Return</span>
        <span>ğŸ›¡ï¸ Quality Assured</span>
      </div>
      <div class="pincode">
        <input placeholder="Check delivery pincode" [(ngModel)]="pin" name="pin" maxlength="6" />
        <button class="btn" (click)="checkPin()">Check</button>
        <span class="eta" *ngIf="eta">Estimated delivery by {{ eta }}</span>
      </div>
      <div class="actions">
        <div class="qty">
          <button class="q" (click)="dec()" aria-label="Decrease quantity">âˆ’</button>
          <input [value]="qty" readonly aria-label="Quantity" />
          <button class="q" (click)="inc()" aria-label="Increase quantity">ï¼‹</button>
        </div>
        <button class="btn primary" (click)="addToCart()">Add to Cart</button>
        <button class="btn wish" type="button" (click)="wishlist.toggle(p.id || p.slug)">{{ wishlist.has(p.id || p.slug) ? 'â™¥ï¸ Wishlisted' : 'â™¡ Wishlist' }}</button>
        <a class="btn" routerLink="/cart" *ngIf="added">View Cart</a>
        <a class="btn" routerLink="/contact">Enquire</a>
        <a class="btn" target="_blank" rel="noopener" [href]="whatsappProductLink(p)">WhatsApp</a>
        <button class="btn" type="button" (click)="copyLink()">Copy Link</button>
      </div>
      <div class="added" *ngIf="added">Added to cart âœ“</div>
      <div class="trust">
        <div class="item"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12l2-2 4 4 10-10 2 2-12 12z"/></svg> Quality Assured</div>
        <div class="item"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="22" height="13" rx="2" ry="2"/><line x1="1" y1="8" x2="23" y2="8"/><path d="M5 21h14"/></svg> Secure Payments</div>
        <div class="item"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12h18"/><path d="M3 12l3 3 3-3-3-3-3 3z"/></svg> 7â€‘day Returns</div>
        <div class="item"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="3" width="15" height="13" rx="2"/><path d="M16 8h4l3 3v5a2 2 0 0 1-2 2h-5z"/></svg> Free Shipping</div>
      </div>
      <details class="acc" open>
        <summary>Product Details</summary>
        <table>
          <tr><th>Category</th><td>{{ p.category }}</td></tr>
          <tr><th>Tags</th><td>{{ p.tags?.join(', ') || 'â€”' }}</td></tr>
          <tr><th>SKU</th><td>{{ p.id || p.slug }}</td></tr>
          <tr><th>Finish</th><td>{{ tone | titlecase }}</td></tr>
          <tr><th>Size</th><td>{{ size }}</td></tr>
        </table>
      </details>
      <details class="acc">
        <summary>Shipping & Returns</summary>
        <p>Ships in 24â€“48h. Free shipping across India. 7â€‘day easy returns.</p>
      </details>
      <details class="acc">
        <summary>Care Instructions</summary>
        <p>Store in a dry place. Avoid perfumes/chemicals. Wipe with a soft cloth.</p>
      </details>

      <div class="offers">
        <div class="offer">ğŸ‰ Festive Offer: Use code CLAY10 for 10% OFF (orders over â‚¹4,999)</div>
        <div class="offer">ğŸ’³ UPI / Cards / Netbanking available</div>
      </div>

    </div>
  </div>
</section>
<ng-template #pending>
  <!-- On the server, keep this minimal to avoid flashing 'not found'. -->
  <section class="container" *ngIf="loaded; else skeleton">
    <div class="info">
      <h1>Product not found</h1>
      <p>We couldnâ€™t find this piece. Explore our latest collections.</p>
      <a class="btn" routerLink="/collections">Back to Collections</a>
    </div>
  </section>
  <ng-template #skeleton>
    <section class="container"><div class="info"><h1>Loadingâ€¦</h1></div></section>
  </ng-template>
</ng-template>

<section class="container related" *ngIf="product as prod">
  <h2>Similar Pieces</h2>
  <div class="grid">
    <app-product-card *ngFor="let r of related" [product]="r" />
  </div>
</section>

<!-- Reviews -->
<section class="container reviews" *ngIf="product as p">
  <div class="head">
    <h2>Customer Reviews</h2>
    <div class="summary"><span class="stars">â˜…â˜…â˜…â˜…â˜…</span> <b>{{ avgStars }}</b>/5 Â· {{ reviews.length }} review{{ reviews.length===1? '' : 's' }}</div>
    <button class="btn" type="button" (click)="shareNative()">Share</button>
  </div>
  <div class="review-list">
    <div class="item" *ngFor="let r of reviews; let i = index">
      <div class="meta">
        <span class="stars" [attr.aria-label]="r.stars + ' stars'">{{ 'â˜…â˜…â˜…â˜…â˜…'.slice(0, r.stars) }}</span>
        <span class="name">{{ r.name }}</span>
        <span class="date">{{ r.date | date:'mediumDate' }}</span>
      </div>
      <p class="text">{{ r.text }}</p>
    </div>
    <div class="empty" *ngIf="reviews.length===0">Be the first to review this product.</div>
  </div>

  <form class="review-form" (submit)="addReview($event)">
    <label>Rating</label>
    <div class="stars-input">
      <button type="button" *ngFor="let s of [1,2,3,4,5]" (click)="selectStars(s)" [class.active]="newStars>=s" aria-label="{{s}} star">â˜…</button>
    </div>
    <label>Your name (optional)</label>
    <input type="text" [value]="newName" (input)="newName=$any($event.target).value" placeholder="Name"/>
    <label>Your review</label>
    <textarea rows="3" [value]="newText" (input)="newText=$any($event.target).value" placeholder="What did you like?"></textarea>
    <button class="btn primary" type="submit" [disabled]="!newText.trim().length">Submit review</button>
  </form>
</section>

<!-- Fullscreen lightbox -->
<div class="lightbox" *ngIf="fsOpen" (click)="closeFs()">
  <div class="inner" (click)="$event.stopPropagation()">
    <button class="close" (click)="closeFs()" aria-label="Close">Ã—</button>
    <button class="nav prev" *ngIf="product && product.images && product.images.length > 1" (click)="prevImage()" aria-label="Previous">â€¹</button>
    <button class="nav next" *ngIf="product && product.images && product.images.length > 1" (click)="nextImage()" aria-label="Next">â€º</button>
    <div class="canvas" (touchstart)="fsTouchStart($event)" (touchmove)="fsTouchMove($event)" (touchend)="fsTouchEnd()" (dblclick)="toggleFsZoom()">
      <img [src]="selectedImage || product?.images?.[0]" [alt]="product?.name || ''"
           [style.transform]="'translate('+fsTx+'px,'+fsTy+'px) scale('+fsZoom+')'" />
    </div>
    <div class="thumbs">
      <button *ngFor="let img of product?.images || []" (click)="select(img)" [attr.aria-selected]="(selectedImage || product?.images?.[0])===img" [class.active]="(selectedImage || product?.images?.[0])===img">
        <img [src]="img" [alt]="product?.name || ''" />
      </button>
    </div>
  </div>
  </div>

<!-- Sticky add-to-cart on mobile -->
<div class="sticky-bar" *ngIf="product as p">
  <div class="inner">
    <div class="title">{{ p.name }}</div>
    <div class="price">{{ p.price | currency: p.currency }}</div>
    <div class="qty">
      <button class="q" (click)="dec()" aria-label="Decrease quantity">âˆ’</button>
      <input [value]="qty" readonly aria-label="Quantity" />
      <button class="q" (click)="inc()" aria-label="Increase quantity">ï¼‹</button>
    </div>
    <button class="btn primary" (click)="addToCart()">Add to Cart</button>
  </div>
  </div>
